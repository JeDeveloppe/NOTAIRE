{# templates/site/notary/presentation.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}Devenir Notaire Référent - Lignée{% endblock %}

{% block body %}
    {% set titreOffre = mainOffers|length > 1 ? "Offres de souscription" : "Offre de souscription" %}

    <div class="notary-ux-page bg-white min-vh-100 pb-5">

        {# --- HEADER --- #}
        <div class="container pt-4 mb-5">
            <div class="d-flex justify-content-between align-items-center bg-white border rounded-pill px-4 py-2 shadow-sm">
                <div class="d-flex align-items-center">
                    <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px;">
                        <i class="fas fa-balance-scale text-white fs-6"></i>
                    </div>
                    <span class="fw-bold text-dark small tracking-wider">LIGNÉE | SERVICES NOTAIRES</span>
                </div>
            </div>
        </div>

        {# --- HERO --- #}
        <section class="py-4 container">
            <h1 class="display-3 fw-black text-dark mb-4">
                Captez les projets de donation <span class="text-primary">dès leur réflexion.</span>
            </h1>
            <p class="fs-5 text-secondary mb-5 fw-medium">
                Lignée connecte votre étude aux familles qui simulent leurs abattements fiscaux.
            </p>
        </section>

        {# --- OFFRES & ADDONS --- #}
        <section class="container py-5 text-center">
            <h2 class="fw-black h1 mb-4">Nos {{ titreOffre }}</h2>

            <div class="row g-4 justify-content-center mb-5">
                {% for offer in mainOffers %}
                    <div class="col-lg-4 text-start">
                        <div class="card h-100 border rounded-4 p-4 shadow-sm bg-white offer-card">
                            <h3 class="h4 fw-bold text-dark">{{ offer.name }}</h3>
                            <div class="h2 fw-black my-3">
                                {{ (offer.currentPrice.amountHt / 100)|number_format(0, ',', ' ') }}€
                                <small class="fs-6 text-muted">/m HT</small>
                            </div>
                            <ul class="list-unstyled mb-4 flex-grow-1 small">
                                <li><i class="fas fa-check text-success me-2"></i><strong>{{ offer.baseNotariesCount }} secteur(s)</strong> inclus</li>
                                <li><i class="fas fa-check text-success me-2"></i>Co-exclusivité limitée</li>
                            </ul>
                            <a href="#check-zone" class="btn btn-outline-primary w-100 rounded-pill fw-bold">Vérifier</a>
                        </div>
                    </div>
                {% endfor %}
            </div>

            {% if addons|length > 0 %}
                <div class="p-4 bg-light rounded-4 border-dashed">
                    <h4 class="fw-bold mb-3 small text-uppercase text-muted">Extensions de zone</h4>
                    <div class="row g-3 justify-content-center">
                        {% for addon in addons %}
                            <div class="col-md-3">
                                <div class="bg-white p-3 border rounded-3 text-start">
                                    <div class="fw-bold text-primary">+{{ addon.baseNotariesCount }} secteur(s)</div>
                                    <div class="fw-bold">+{{ (addon.currentPrice.amountHt / 100)|number_format(0, ',', ' ') }}€ HT</div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        </section>

        {# --- RECHERCHE ZIP --- #}
        <section id="check-zone" class="py-5 bg-light border-top">
            <div class="container py-5 text-center">
                <h2 class="fw-black mb-4">Disponibilité par secteur</h2>

                <div class="mx-auto shadow-sm bg-white p-2 rounded-pill border d-flex mb-5 search-bar" style="max-width: 500px;">
                    <input type="text" id="zipCodeInput" class="form-control border-0 shadow-none ps-4" placeholder="Code postal (ex: 14540)" maxlength="5">
                    <button class="btn btn-primary rounded-pill px-4 fw-bold" id="btnCheckZip">Vérifier</button>
                </div>

                <div id="zipError" class="text-danger fw-bold d-none mb-3">Veuillez entrer un code postal valide.</div>

                <div id="zipResponse" class="d-none mx-auto text-start fade-in" style="max-width: 700px;">
                    <div class="card border-0 shadow-lg rounded-4 overflow-hidden">
                        <div id="statusStripe" style="height: 6px;"></div>

                        <div class="p-4 p-md-5 bg-white">
                            <div class="d-flex align-items-center mb-4 pb-4 border-bottom">
                                <div id="statusIconContainer" class="rounded-circle d-flex align-items-center justify-content-center me-4" style="width: 60px; height: 60px;">
                                    <i id="zipIcon" class="fas fa-2x"></i>
                                </div>
                                <div>
                                    <div id="availabilityBadge" class="badge rounded-pill mb-1"></div>
                                    <h3 id="zipTitle" class="fw-black mb-0 h3"></h3>
                                </div>
                            </div>

                            <p id="zipText" class="fw-bold mb-4"></p>

                            <div id="citiesWrapper" class="row g-2 mb-4"></div>

                            <a href="#" id="btnContinueRegister" class="btn btn-primary btn-lg w-100 fw-black rounded-pill py-3">CONTINUER</a>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <style>
        .fw-black { font-weight: 900; }
        .bg-success-subtle { background-color: #d1fae5 !important; color: #065f46; }
        .bg-warning-subtle { background-color: #fef3c7 !important; color: #92400e; }
        .border-dashed { border: 2px dashed #dee2e6 !important; }

        .offer-card {
            transition: transform .2s ease, box-shadow .2s ease;
        }
        .offer-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
        }

        .city-item {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .fade-in {
            animation: fadeIn .3s ease forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .btn-loading {
            pointer-events: none;
            opacity: .7;
        }
    </style>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const input = document.getElementById('zipCodeInput');
        const btn = document.getElementById('btnCheckZip');
        const responseDiv = document.getElementById('zipResponse');
        const errorDiv = document.getElementById('zipError');
        const citiesWrapper = document.getElementById('citiesWrapper');
        const iconContainer = document.getElementById('statusIconContainer');
        const icon = document.getElementById('zipIcon');
        const title = document.getElementById('zipTitle');
        const badge = document.getElementById('availabilityBadge');
        const text = document.getElementById('zipText');
        const btnRegister = document.getElementById('btnContinueRegister');
        const stripe = document.getElementById('statusStripe');

        const showLoading = () => {
            btn.classList.add('btn-loading');
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        };

        const hideLoading = () => {
            btn.classList.remove('btn-loading');
            btn.innerHTML = 'Vérifier';
        };

        const search = () => {
            const zip = input.value.trim();

            if (zip.length !== 5 || isNaN(zip)) {
                errorDiv.classList.remove('d-none');
                return;
            }

            errorDiv.classList.add('d-none');
            showLoading();

            fetch('/api/check-zip/' + zip)
                .then(r => r.json())
                .then(data => {
                    hideLoading();

                    if (data.status !== 'ok') {
                        alert("Erreur lors de la vérification.");
                        return;
                    }

                    responseDiv.classList.remove('d-none');
                    responseDiv.classList.add('fade-in');
                    citiesWrapper.innerHTML = '';

                    if (data.available) {
                        icon.className = "fas fa-check text-success";
                        iconContainer.className = "bg-success-subtle d-flex align-items-center justify-content-center rounded-circle me-4";
                        stripe.className = "bg-success";
                        title.innerText = "Secteur " + data.postalCode;
                        badge.className = "badge bg-success mb-2 px-3 py-2";
                        badge.innerText = "DISPONIBLE";
                        text.innerText = "Voici les communes avec des places libres :";
                        btnRegister.innerHTML = "S'INSCRIRE SUR CE SECTEUR";
                        btnRegister.href = "{{ path('app_register') }}?zip=" + data.postalCode;
                        btnRegister.className = "btn btn-primary btn-lg w-100 fw-black rounded-pill py-3";
                    } else {
                        icon.className = "fas fa-lock text-warning";
                        iconContainer.className = "bg-warning-subtle d-flex align-items-center justify-content-center rounded-circle me-4";
                        stripe.className = "bg-warning";
                        title.innerText = "Secteur " + data.postalCode;
                        badge.className = "badge bg-warning text-dark mb-2 px-3 py-2";
                        badge.innerText = "COMPLET";
                        text.innerText = "Ce secteur est complet.";
                        btnRegister.innerHTML = "ÊTRE PRÉVENU";
                        btnRegister.href = "mailto:pro@lignee.fr";
                        btnRegister.className = "btn btn-dark btn-lg w-100 fw-black rounded-pill py-3";
                    }

                    if (data.cities) {
                        data.cities.forEach(c => {
                            const col = document.createElement('div');
                            col.className = 'col-md-6';
                            const label = c.isFull
                                ? '<span class="text-muted small">Complet</span>'
                                : '<span class="text-success small fw-bold">' + c.remaining + ' place(s)</span>';
                            col.innerHTML = `<div class="city-item"><span class="small fw-bold">${c.name}</span>${label}</div>`;
                            citiesWrapper.appendChild(col);
                        });
                    }

                    responseDiv.scrollIntoView({ behavior: 'smooth' });
                })
                .catch(() => {
                    hideLoading();
                    alert("Impossible de contacter le serveur.");
                });
        };

        btn.onclick = search;
        input.oninput = () => { if (input.value.length === 5) search(); };
    });
    </script>
{% endblock %}
