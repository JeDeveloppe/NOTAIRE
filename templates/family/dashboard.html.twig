{% extends 'base.html.twig' %}

{% block title %}Tableau de Bord Patrimonial
{% endblock %}

{% block body %}
	<div class="container-fluid py-4 bg-light min-vh-100">
		<div
			class="container">

			{# --- EN-TÊTE AVEC BOUTON D'ACTION --- #}
			<div class="d-flex justify-content-between align-items-center mb-4">
				<div>
					<h1 class="h3 mb-1 fw-bold">Tableau de Bord Famille</h1>
					<p class="text-muted small mb-0">Vue d'ensemble de votre stratégie de transmission</p>
				</div>
				{# ICI LE BOUTON + #}
				{% include "components/buttons/_add_donation.html.twig" %}
			</div>

			{# --- STATS RAPIDES --- #}
			<div class="row g-3 mb-5">
				<div class="col-md-4">
					<div class="card border-0 shadow-sm rounded-4 p-3 h-100">
						<div class="d-flex align-items-center">
							<div class="icon-shape bg-primary-subtle text-primary rounded-3 p-3 me-3">
								<i class="fas fa-users fa-lg"></i>
							</div>
							<div>
								<div class="text-muted small fw-bold text-uppercase" style="font-size: 0.65rem;">Membres</div>
								<div class="h4 mb-0 fw-bold">{{ totalMembers }}</div>
							</div>
						</div>
					</div>
				</div>
				<div class="col-md-4">
					<div class="card border-0 shadow-sm rounded-4 p-3 h-100">
						<div class="d-flex align-items-center">
							<div class="icon-shape bg-warning-subtle text-warning rounded-3 p-3 me-3">
								<i class="fas fa-hourglass-half fa-lg"></i>
							</div>
							<div>
								<div class="text-muted small fw-bold text-uppercase" style="font-size: 0.65rem;">Dons Actifs (-15 ans)</div>
								<div class="h4 mb-0 fw-bold">{{ activeDonations|length }}</div>
							</div>
						</div>
					</div>
				</div>
				<div class="col-md-4">
					<div class="card border-0 shadow-sm rounded-4 p-3 h-100">
						<div class="d-flex align-items-center">
							<div class="icon-shape bg-success-subtle text-success rounded-3 p-3 me-3">
								<i class="fas fa-check-circle fa-lg"></i>
							</div>
							<div>
								<div class="text-muted small fw-bold text-uppercase" style="font-size: 0.65rem;">Dons Purgés (+15 ans)</div>
								<div class="h4 mb-0 fw-bold">{{ expiredDonations|length }}</div>
							</div>
						</div>
					</div>
				</div>
			</div>

			<div
				class="row g-4">
				{# --- DONS ACTIFS --- #}
				<div class="col-lg-8">
					<div class="card border-0 shadow-sm rounded-4">
						<div class="card-header bg-white border-0 pt-4 px-4 d-flex justify-content-between align-items-center">
							<div>
								<h5 class="fw-bold mb-0">
									<i class="fas fa-exclamation-circle text-warning me-2"></i>Dons en cours de rapport fiscal</h5>
								<p class="text-muted small mb-0">Impactent les plafonds actuels</p>
							</div>
							<span class="badge bg-light text-dark rounded-pill border">{{ activeDonations|length }}
								dons</span>
						</div>
						<div class="card-body px-4 pb-4">
							<div class="table-responsive">
								<table class="table table-hover align-middle">
									<thead class="table-light">
										<tr style="font-size: 0.75rem; text-transform: uppercase;">
											<th>Donateur</th>
											<th>Bénéficiaire</th>
											<th>Montant</th>
											<th>Type</th>
											<th>Date</th>
										</tr>
									</thead>
									<tbody>
										{% for donation in activeDonations %}
											<tr>
												<td class="fw-bold">{{ donation.donor.firstname }}</td>
												<td>{{ donation.beneficiary.firstname }}</td>
												<td class="text-primary fw-bold">{{ donation.amount|number_format(0, ',', ' ') }}
													€</td>
												<td>
													<span class="badge bg-{{ donation.type|lower == 'sarkozy' ? 'warning' : 'info' }}-subtle text-dark border-0" style="font-size: 0.6rem;">
														{{ donation.type|upper }}
													</span>
												</td>
												<td class="small text-muted">{{ donation.createdAt|date('d/m/Y') }}</td>
											</tr>
										{% else %}
											<tr>
												<td colspan="5" class="text-center py-5 text-muted italic">Aucun don actif enregistré</td>
											</tr>
										{% endfor %}
									</tbody>
								</table>
							</div>
						</div>
					</div>
				</div>

				{# --- DONS PURGÉS --- #}
				<div class="col-lg-4">
					<div class="card border-0 shadow-sm rounded-4 h-100">
						<div class="card-header bg-white border-0 pt-4 px-4">
							<h5 class="fw-bold text-success mb-0">
								<i class="fas fa-history me-2"></i>Dons purgés</h5>
							<p class="text-muted small mb-0">Abattements entièrement reconstitués</p>
						</div>
						<div class="card-body px-4 pb-4">
							<div class="history-timeline">
								{% for donation in expiredDonations %}
									<div class="d-flex justify-content-between align-items-center mb-3 p-3 bg-light rounded-3 border-start border-success border-4">
										<div class="ps-2">
											<div class="small fw-bold text-dark">{{ donation.donor.firstname }}
												→
												{{ donation.beneficiary.firstname }}</div>
											<div class="text-muted" style="font-size: 0.7rem;">
												<i class="far fa-calendar-alt me-1"></i>Acté en
												{{ donation.createdAt|date('m/Y') }}
											</div>
										</div>
										<div class="text-success fw-bold">
											{{ donation.amount|number_format(0, ',', ' ') }}
											€
										</div>
									</div>
								{% else %}
									<div class="text-center py-4">
										<i class="fas fa-calendar-check text-light fa-3x mb-3"></i>
										<p class="text-muted small italic">Aucun don de plus de 15 ans.</p>
									</div>
								{% endfor %}
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<style>
		.icon-shape {
			width: 48px;
			height: 48px;
			display: flex;
			align-items: center;
			justify-content: center;
			transition: 0.3s;
		}
		.card {
			transition: all 0.25s ease;
			border: 1px solid rgba(0, 0, 0, 0.05) !important;
		}
		.card:hover {
			transform: translateY(-3px);
			box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08) !important;
		}
		.table thead th {
			border-top: none;
			color: #64748b;
			font-weight: 700;
		}
		.btn-primary {
			background: #2563eb;
			border: none;
		}
		.btn-primary:hover {
			background: #1d4ed8;
		}
	</style>
{% endblock %}
