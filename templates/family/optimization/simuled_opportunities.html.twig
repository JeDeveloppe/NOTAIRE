{% extends 'base.html.twig' %}

{% block title %}Plan de transmission
{% endblock %}

{% block body %}
	<div class="container-fluid py-5 bg-light min-vh-100">
		<div
			class="container">

			{# --- HEADER --- #}
			<div class="row mb-5 align-items-end">
				<div class="col-md-7">
					<h1 class="fw-bold display-6 mb-1 text-dark">Plan de Transmission Familial</h1>
					<p class="text-muted">Suivi des abattements fiscaux et calendrier de régénération des droits.</p>
				</div>
				<div class="col-md-5">
					<div class="card border-0 shadow-sm rounded-4 bg-white p-3">
						<form action="{{ path('app_optimization_dashboard') }}" method="get" class="row g-2 align-items-center">
							<div class="col-sm-8">
								<label class="small fw-bold text-muted text-uppercase mb-1 d-block">Simuler à une date future</label>
								<input type="date" name="date" class="form-control form-control-sm" value="{{ referenceDate|date('Y-m-d') }}">
							</div>
							<div class="col-sm-4">
								<label class="d-none d-sm-block mb-1">&nbsp;</label>
								<button type="submit" class="btn btn-primary btn-sm w-100 fw-bold">Calculer</button>
							</div>
						</form>
					</div>
				</div>
			</div>

			{# --- CHIFFRES CLÉS : PROTECTION FISCALE --- #}
			<div class="row g-4 mb-5">
				<div class="col-md-6">
					<div class="card border-0 shadow-sm rounded-4 bg-white border-start border-4 border-success">
						<div class="card-body p-4">
							<div class="small text-muted text-uppercase fw-bold mb-1">Capacité de transmission immédiate</div>
							<h2 class="fw-bold text-dark mb-0">{{ totalAvailable|number_format(0, ',', ' ') }}
								€</h2>
							<div class="small text-success mt-2">
								<i class="fas fa-shield-alt"></i>
								Montant totalement exonéré de droits de succession
							</div>
						</div>
					</div>
				</div>
				<div class="col-md-6">
					<div class="card border-0 shadow-sm rounded-4 bg-dark text-white border-start border-4 border-warning">
						<div class="card-body p-4">
							<div class="small text-uppercase fw-bold mb-1 text-warning">Impôts économisés</div>
							<h2 class="fw-bold mb-0 text-white">{{ totalTaxSaving|number_format(0, ',', ' ') }}
								€</h2>
							<div class="small mt-2 opacity-75">
								<i class="fas fa-info-circle me-1"></i>
								C'est le montant que vos proches
								<strong>ne paieront pas</strong>
								à l'administration fiscale en utilisant ces abattements dès maintenant.
							</div>
						</div>
					</div>
				</div>
			</div>

			{# --- RÉPARTITION PAR BÉNÉFICIAIRE --- #}
			<h5 class="fw-bold mb-4 text-dark">
				<i class="fas fa-users me-2 text-primary"></i>État des abattements par bénéficiaire</h5>
			<div
				class="row g-4 mb-5">
				{# Correction du bug de clé Twig #}
				{% set groupedPlan = {} %}
				{% for item in familyPlan %}
					{% set benKey = 'ID_' ~ item.beneficiary.id %}
					{% if groupedPlan[benKey] is not defined %}
						{% set groupedPlan = groupedPlan|merge({(benKey): {'name': item.beneficiary.firstname, 'id': item.beneficiary.id, 'items': []}}) %}
					{% endif %}
					{% set currentGroup = groupedPlan[benKey] %}
					{% set newItems = currentGroup.items|merge([item]) %}
					{% set groupedPlan = groupedPlan|merge({(benKey): currentGroup|merge({'items': newItems})}) %}
				{% endfor %}

				{% for group in groupedPlan %}
					<div class="col-lg-6">
						<div class="card border-0 shadow-sm rounded-4 h-100">
							<div class="card-header bg-white p-4 border-0 d-flex justify-content-between align-items-center">
								<h4 class="fw-bold mb-0">{{ group.name }}</h4>
								<div class="text-end">
									{% set totalBen = 0 %}
									{% for op in group.items %}
										{% set totalBen = totalBen + op.available %}
									{% endfor %}
									<span class="badge bg-success-subtle text-success fs-6">{{ totalBen|number_format(0, ',', ' ') }}
										€ disponibles</span>
								</div>
							</div>
							<div class="card-body p-4 pt-0">
								<table class="table table-sm table-borderless align-middle mb-0">
									<thead class="text-muted small text-uppercase">
										<tr>
											<th>Origine</th>
											<th>Type</th>
											<th class="text-end">Disponible</th>
										</tr>
									</thead>
									<tbody>
										{% for op in group.items %}
											<tr class="border-top border-light">
												<td class="py-3">
													<div class="fw-bold text-dark">{{ op.donor.firstname }}</div>
													<div class="small text-muted">{{ op.donor.getAge(referenceDate) }}
														ans</div>
												</td>
												<td class="py-3">
													<span class="small">{{ op.label }}</span>
												</td>
												<td class="py-3 text-end">
													<div class="fw-bold text-primary">{{ op.available|number_format(0, ',', ' ') }}
														€</div>
													<a href="{{ path('app_donation_new', {donor: op.donor.id, beneficiary: group.id}) }}" class="btn btn-link btn-sm p-0 text-decoration-none" style="font-size: 0.75rem;">Saisir un don</a>
												</td>
											</tr>
										{% endfor %}
									</tbody>
								</table>
							</div>
						</div>
					</div>
				{% endfor %}
			</div>

			{# --- TIMELINE : ÉCHÉANCIER DE RÉGÉNÉRATION --- #}
			<div class="d-flex justify-content-between align-items-center mb-4">
				<h5 class="fw-bold mb-0">
					<i class="fas fa-history me-2 text-primary"></i>Calendrier de rappel fiscal (15 ans)</h5>
				<span class="badge bg-white text-muted border px-3 py-2 rounded-pill">Total des droits en cours :
					{{ activePeriods|length }}</span>
			</div>

			<div class="row g-4">
				{% for period in activePeriods|sort((a, b) => a.endDate <=> b.endDate) %}
					<div class="col-md-6 col-xl-4">
						<div class="card border-0 shadow-sm rounded-4 {{ period.endDate < referenceDate ? 'bg-success-subtle border-start border-4 border-success' : 'bg-white border-start border-4 border-light' }}">
							<div class="card-body p-3">
								<div class="d-flex justify-content-between align-items-start mb-2">
									<div class="bg-light rounded p-2 text-center border" style="min-width: 60px;">
										<div class="fw-bold mb-0">{{ period.endDate|date('d/m') }}</div>
										<div class="small fw-bold text-muted">{{ period.endDate|date('Y') }}</div>
									</div>
									{% if period.endDate < referenceDate %}
										<span class="badge bg-success">Libéré</span>
									{% else %}
										<span class="small text-muted">{{ period.endDate.diff(referenceDate).days }}
											jours restants</span>
									{% endif %}
								</div>
								<div class="fw-bold text-dark">{{ period.donor }}
									<i class="fas fa-arrow-right mx-1 text-muted small"></i>
									{{ period.beneficiary }}</div>
								<div class="small text-muted">{{ period.type }}
									:
									<strong>{{ period.plafond|number_format(0, ',', ' ') }}
										€</strong>
								</div>
							</div>
						</div>
					</div>
				{% endfor %}
			</div>

			{# --- NOTE DE SÉCURITÉ --- #}
			<div class="mt-5 p-4 bg-white rounded-4 shadow-sm border">
				<div class="d-flex">
					<i class="fas fa-info-circle text-primary me-3 fa-lg mt-1"></i>
					<div>
						<h6 class="fw-bold mb-1">Règle fiscale du rappel de 15 ans</h6>
						<p class="small text-muted mb-0">
							Pour bénéficier à nouveau d'un abattement total, un délai de 15 ans doit s'écouler entre deux donations entre les mêmes personnes. Ce calendrier vous permet de visualiser précisément la date à laquelle vos droits sont "purgés" et redeviennent disponibles.
						</p>
					</div>
				</div>
			</div>

		</div>
	</div>

	<style>
		.bg-success-subtle {
			background-color: #f0fdf4 !important;
		}
		.bg-primary-subtle {
			background-color: #eff6ff !important;
		}
		.text-success {
			color: #15803d !important;
		}
		.table-borderless >:not(caption) > * > * {
			border-bottom-width: 0;
		}
	</style>
{% endblock %}
