{% extends 'base.html.twig' %}

{% block title %}Calendrier Stratégique Familial
{% endblock %}

{% block body %}
	<div class="container-fluid py-5 bg-light min-vh-100">
		<div
			class="container">

			{# --- HEADER & STATS --- #}
			<div class="row mb-4 align-items-center">
				<div class="col-md-7">
					<h1 class="fw-bold display-6 mb-1">Plan d'Optimisation Global</h1>
					<p class="text-muted">Explorez les capacités de transmission immédiates et futures au sein de votre famille.</p>
				</div>
				<div class="col-md-5 text-md-end">
					<div class="p-3 bg-white shadow-sm rounded-4 border-start border-4 border-success d-inline-block text-start me-2">
						<div class="small fw-bold text-success text-uppercase" style="font-size: 0.6rem;">
							Capacité au
							{{ referenceDate|date('d/m/Y') }}
						</div>
						<div class="h3 fw-bold mb-0 text-dark">{{ totalAvailable|number_format(0, ',', ' ') }}
							€</div>
					</div>
				</div>
			</div>

			{# --- FILTRE DE SIMULATION TEMPORELLE --- #}
			<div class="card border-0 shadow-sm rounded-4 mb-5 bg-dark text-white">
				<div class="card-body p-4">
					<div class="row align-items-center">
						<div class="col-md-7">
							<h5 class="fw-bold mb-1">
								<i class="fas fa-magic text-warning me-2"></i>Simulateur temporel</h5>
							<p class="small mb-0 opacity-75">Modifiez la date pour voir quels abattements se seront libérés (après le délai de 15 ans).</p>
						</div>
						<div class="col-md-5">
							<form action="{{ path('app_optimization_dashboard') }}" method="get" class="d-flex gap-2 justify-content-md-end mt-3 mt-md-0">
								<div class="input-group" style="max-width: 250px;">
									<span class="input-group-text bg-white border-0">
										<i class="fas fa-calendar-alt text-muted"></i>
									</span>
									<input type="date" name="date" class="form-control border-0" value="{{ referenceDate|date('Y-m-d') }}">
								</div>
								<button type="submit" class="btn btn-primary rounded-pill px-4 fw-bold">Simuler</button>
								{% if app.request.query.get('date') %}
									<a href="{{ path('app_optimization_dashboard') }}" class="btn btn-outline-light rounded-circle" title="Réinitialiser">
										<i class="fas fa-sync-alt"></i>
									</a>
								{% endif %}
							</form>
						</div>
					</div>
				</div>
			</div>

			{% if referenceDate > date() %}
				<div class="alert alert-warning rounded-4 border-0 shadow-sm mb-4 d-flex align-items-center">
					<div class="icon-box bg-warning text-dark rounded-circle me-3" style="min-width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
						<i class="fas fa-eye"></i>
					</div>
					<div>
						<h6 class="fw-bold mb-0">Mode Projection :
							{{ referenceDate|date('d/m/Y') }}</h6>
						<small>Les montants ci-dessous incluent les abattements qui se seront régénérés d'ici cette date.</small>
					</div>
				</div>
			{% endif %}

			<div
				class="row g-4">
				{# --- ACTIONS PRIORITAIRES (DONS DISPONIBLES À LA DATE DONNÉE) --- #}
				<div class="col-lg-12">
					<div class="card border-0 shadow-sm rounded-4">
						<div class="card-header bg-white py-4 px-4 border-0 d-flex justify-content-between align-items-center">
							<h5 class="fw-bold mb-0">
								<i class="fas fa-rocket text-success me-2"></i>
								Optimisations possibles
								<span class="text-muted fw-normal" style="font-size: 0.9rem;">(à la date simulée)</span>
							</h5>
						</div>
						<div class="table-responsive">
							<table class="table align-middle mb-0">
								<thead class="bg-light">
									<tr class="small text-uppercase text-muted" style="font-size: 0.65rem;">
										<th class="ps-4">Donateur</th>
										<th>Bénéficiaire</th>
										<th>Type d'Abattement</th>
										<th>Potentiel de transmission</th>
									</tr>
								</thead>
								<tbody>
									{% for item in familyPlan %}
										<tr>
											<td class="ps-4">
												<div class="fw-bold text-dark">{{ item.donor.firstname }}</div>
												<div class="small text-muted">
													{{ item.donor.getAge(referenceDate) }}
													ans
													<span class="opacity-50">(en
														{{ referenceDate|date('Y') }})</span>
												</div>
											</td>
											<td class="ps-4">
												<div class="fw-bold text-dark">{{ item.beneficiary.firstname }}</div>
												<div class="small text-muted">
													{{ item.beneficiary.getAge(referenceDate) }}
													ans
													<span class="opacity-50">(en
														{{ referenceDate|date('Y') }})</span>
												</div>
											</td>
											<td>
												<span class="badge {{ 'sarkozy' in item.type ? 'bg-info-subtle text-info border-info' : 'bg-light text-dark border' }} border px-2 py-1">
													{{ item.label }}
												</span>
											</td>
											<td>
												<div class="fw-bold text-success" style="font-size: 1.1rem;">
													{{ item.available|number_format(0, ',', ' ') }}
													€
												</div>
											</td>
										</tr>
									{% else %}
										<tr>
											<td colspan="5" class="text-center py-5">
												<i class="fas fa-info-circle text-muted mb-2 fa-2x"></i>
												<p class="text-muted mb-0">Aucun abattement disponible pour cette configuration à cette date.</p>
											</td>
										</tr>
									{% endfor %}
								</tbody>
							</table>
						</div>
					</div>
				</div>

				{# --- CALENDRIER RÉEL DES LIBÉRATIONS (RAPPEL FISCAL) --- #}
				<div class="col-lg-12 mt-4">
					<div class="d-flex align-items-center mb-4">
						<h5 class="fw-bold mb-0">
							<i class="fas fa-calendar-alt text-primary me-2"></i>Échéancier des droits en cours de rapport</h5>
						<hr class="flex-grow-1 ms-3 opacity-10">
					</div>
					<div class="row row-cols-1 row-cols-md-3 g-4">
						{% for period in activePeriods|sort((a, b) => a.endDate <=> b.endDate) %}
							<div class="col">
								<div class="card border-0 shadow-sm rounded-4 h-100 border-top border-4 {{ period.endDate < referenceDate ? 'border-success' : 'border-primary' }}">
									<div class="card-body">
										<div class="d-flex justify-content-between align-items-start mb-3">
											<div class="text-center bg-light rounded-3 p-2 border">
												<div class="h4 fw-bold mb-0">{{ period.endDate|date('d') }}</div>
												<div class="small fw-bold text-uppercase text-muted" style="font-size: 0.6rem;">{{ period.endDate|date('M Y') }}</div>
											</div>
											{% if period.endDate < referenceDate %}
												<span class="badge bg-success-subtle text-success border border-success border-opacity-25">
													<i class="fas fa-check me-1"></i>
													Sera libéré
												</span>
											{% else %}
												<span class="badge bg-primary-subtle text-primary border border-primary border-opacity-10">
													Dans
													{{ period.endDate.diff(date()).days }}
													jours
												</span>
											{% endif %}
										</div>
										<div class="small text-muted text-uppercase fw-bold" style="font-size: 0.6rem;">Abattement mobilisé</div>
										<h6 class="fw-bold mb-1">{{ period.donor }}
											<i class="fas fa-arrow-right mx-1 small text-muted"></i>
											{{ period.beneficiary }}</h6>
										<p class="small text-muted mb-0">
											Plafond :
											<strong>{{ period.plafond|number_format(0, ',', ' ') }}
												€</strong><br>
											<span class="text-primary">{{ period.type }}</span>
										</p>
									</div>
								</div>
							</div>
						{% else %}
							<div class="col-12 text-center py-4 bg-white rounded-4 shadow-sm">
								<p class="text-muted mb-0">Aucun don actif (tous vos abattements sont déjà disponibles).</p>
							</div>
						{% endfor %}
					</div>
				</div>
			</div>

			{# --- FOOTER INFO --- #}
			<div class="mt-5 p-4 bg-white rounded-4 shadow-sm border">
				<div class="row align-items-center">
					<div class="col-md-1 text-center">
						<i class="fas fa-info-circle text-primary fa-2x"></i>
					</div>
					<div class="col-md-11">
						<h6 class="fw-bold mb-1">Comment fonctionne cette simulation ?</h6>
						<p class="small text-muted mb-0">
							Cette page calcule le reliquat de vos abattements en fonction du
							<strong>délai de rappel fiscal de 15 ans</strong>. 
								                        En changeant la date, le système ignore les donations qui auront plus de 15 ans à cette date-là, libérant ainsi de nouveaux plafonds de transmission.
						</p>
					</div>
				</div>
			</div>
		</div>
	</div>

	<style>
		.bg-info-subtle {
			background-color: #e0f2fe !important;
		}
		.bg-primary-subtle {
			background-color: #eef2ff !important;
		}
		.bg-success-subtle {
			background-color: #f0fdf4 !important;
		}
		.text-info {
			color: #0369a1 !important;
		}
		.border-info {
			border-color: #7dd3fc !important;
		}
		.table td {
			padding: 1.1rem 1rem;
		}
		.card {
			transition: transform 0.2s;
		}
		input[type="date"]::-webkit-calendar-picker-indicator {
			cursor: pointer;
		}
	</style>
{% endblock %}
