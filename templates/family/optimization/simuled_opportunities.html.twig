{# templates/family/optimization/simuled_opportunities.html.twig #}
{% extends 'base.html.twig' %}

{% block body %}
{% set currentYear = "now"|date("Y") %}

<div class="container py-5">
    {# --- HEADER --- #}
    <div class="card border-0 shadow-sm rounded-5 bg-white p-4 mb-5">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="fw-black text-dark mb-1">Potentiel de Transmission</h1>
                <p class="text-muted">Analyse personnalisée des abattements disponibles par bénéficiaire.</p>
            </div>
            <div class="col-md-4 text-md-end">
                <div class="display-5 fw-black text-primary">{{ totalAvailable|number_format(0, ',', ' ') }} €</div>
                <div class="small text-muted fw-bold text-uppercase">Total disponible famille</div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        {# --- COLONNE GAUCHE : LES DONATEURS --- #}
        <div class="col-lg-4">
            <h5 class="fw-bold mb-4 d-flex align-items-center">
                <span class="badge bg-dark rounded-circle me-2" style="width:28px; height:28px;">1</span>
                Donateurs
            </h5>
            {% set donors = [] %}
            {% for item in familyPlan %}
                {% if item.donor.id not in donors %}
                    <div class="card border-0 shadow-sm rounded-4 p-3 mb-3 border-start border-primary border-4">
                        <div class="d-flex align-items-center">
                            <div class="icon-circle bg-light text-primary me-3">
                                <i class="fa-solid fa-user-tie"></i>
                            </div>
                            <div>
                                <h6 class="fw-bold mb-0">{{ item.donor.firstname }}</h6>
                                <small class="text-muted small">Source des abattements</small>
                            </div>
                        </div>
                    </div>
                    {% set donors = donors|merge([item.donor.id]) %}
                {% endif %}
            {% endfor %}
        </div>

        {# --- COLONNE DROITE : LES CARTES PAR BÉNÉFICIAIRE --- #}
        <div class="col-lg-8">
            <h5 class="fw-bold mb-4 d-flex align-items-center">
                <span class="badge bg-dark rounded-circle me-2" style="width:28px; height:28px;">2</span>
                Détail par ligne de transmission
            </h5>

            <div class="row g-3">
                {% for item in familyPlan %}
                <div class="col-md-6">
                    <div class="card border-0 shadow-sm rounded-4 h-100 bg-white">
                        <div class="p-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <span class="x-small text-muted text-uppercase fw-bold">Bénéficiaire</span>
                                    <h6 class="fw-black mb-0">{{ item.beneficiary.firstname }}</h6>
                                </div>
                                <div class="text-end">
                                    <span class="x-small text-muted text-uppercase fw-bold">Donateur</span>
                                    <div class="small fw-bold">{{ item.donor.firstname }}</div>
                                </div>
                            </div>

                            {# On affiche le type d'abattement spécifique envoyé par ton service #}
                            <div class="p-3 border rounded-4 bg-light mb-3 shadow-xs">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="small">
                                        {% if 'sarkozy' in item.type|lower %}
                                            <i class="fa-solid fa-coins text-warning me-2"></i><strong>Don "Sarkozy"</strong>
                                        {% else %}
                                            <i class="fa-solid fa-landmark text-primary me-2"></i><strong>Abattement Légal</strong>
                                        {% endif %}
                                    </div>
                                    <span class="fw-black text-dark">
                                        {{ item.available|number_format(0, ',', ' ') }} €
                                    </span>
                                </div>
                                <div class="x-small text-muted mt-1 ps-4">
                                    {{ item.label }}
                                </div>
                            </div>

                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <div>
                                    <div class="x-small text-muted fw-bold">DISPONIBLE</div>
                                    <div class="h5 fw-black text-primary mb-0">{{ item.available|number_format(0, ',', ' ') }} €</div>
                                </div>
                                <div class="badge bg-success-subtle text-success rounded-pill x-small">
                                    Exonéré
                                </div>
                            </div>
                        </div>

                        <div class="card-footer bg-white border-top-0 pb-3 text-center">
                            <a href="" class="btn btn-sm btn-outline-primary rounded-pill px-3 fw-bold x-small">
                                Préparer avec un notaire
                            </a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    {# --- RAPPEL JURIDIQUE --- #}
    <div class="mt-5 p-4 rounded-4 bg-light border border-dashed text-center">
        <p class="small text-muted mb-0">
            <i class="fa-solid fa-scale-balanced me-2"></i>
            Chaque enfant possède ses propres abattements. Un don fait à <strong>{{ familyPlan[0].beneficiary.firstname|default('un enfant') }}</strong> n'impacte pas les droits de ses frères et sœurs.
        </p>
    </div>
</div>

<style>
    .fw-black { font-weight: 900; }
    .x-small { font-size: 0.65rem; }
    .rounded-5 { border-radius: 2.5rem !important; }
    .icon-circle { width: 45px; height: 45px; border-radius: 12px; display: flex; align-items: center; justify-content: center; }
    .bg-primary-subtle { background-color: #eef2ff; }
    .bg-success-subtle { background-color: #f0fdf4; }
    .shadow-xs { box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
</style>
{% endblock %}