{% extends 'base.html.twig' %}

{% block body %}
    {# 1. INITIALISATION #}
    {% set currentYear = "now"|date("Y") %}
    {% set rechargeYear = currentYear + 15 %}
    {% set groupedPlan = {} %}

    {% for item in familyPlan %}
        {% set benKey = 'BEN_' ~ item.beneficiary.id %}
        {% if groupedPlan[benKey] is not defined %}
            {% set groupedPlan = groupedPlan|merge({(benKey): {
                'name': item.beneficiary.firstname, 
                'items': [], 
                'bId': item.beneficiary.id,
                'rel': item.relationship_code,
                'maxLegal': (item.relationship_code == 'ENFANT') ? 100000 : 31865
            }}) %}
        {% endif %}
        {% set currentGroup = groupedPlan[benKey] %}
        {% set groupedPlan = groupedPlan|merge({(benKey): currentGroup|merge({'items': currentGroup.items|merge([item])})}) %}
    {% endfor %}

<div class="container py-5">
    {# HEADER #}
    <div class="text-center mb-4">
        <h2 class="fw-black mb-0 text-dark">Stratégie de Transmission Familiale</h2>
    </div>

    {# --- SECTION 1 : LA FRISE ET LE TEXTE À TROUS --- #}
    <div class="card border-0 shadow-lg rounded-5 bg-white p-5 mb-5 overflow-hidden">
        {# Frise simplifiée #}
        <div class="row align-items-center mb-5 position-relative">
            <div class="position-absolute w-75 start-50 translate-middle-x d-none d-md-block" style="height: 2px; background: #f1f3f5; top: 20px; z-index: 1;">
                <div id="timeline-progress" class="bg-success h-100" style="width: 0%; transition: width 0.6s ease;"></div>
            </div>
            <div class="col-4 text-center position-relative" style="z-index: 2;">
                <div class="bg-primary text-white rounded-circle shadow-sm mx-auto mb-2 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">{{ currentYear }}</div>
            </div>
            <div class="col-4 text-center position-relative" style="z-index: 2;">
                <div id="step-mid" class="bg-light text-muted rounded-circle mx-auto mb-2 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; transition: 0.4s;">15 ans</div>
            </div>
            <div class="col-4 text-center position-relative" style="z-index: 2;">
                <div id="step-end" class="bg-light text-muted rounded-circle mx-auto mb-2 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; transition: 0.4s;">{{ rechargeYear }}</div>
            </div>
        </div>

        {# LE TEXTE À TROUS DYNAMIQUE #}
        <div class="bg-light rounded-4 p-4 text-center">
            <h4 class="fw-normal lh-base mb-0" id="dynamic-story">
                En activant la donation aujourd'hui, 
                <span class="badge bg-white text-primary border px-3" id="slot-donor">Donateur</span> 
                transmet un abattement à 
                <span class="badge bg-white text-primary border px-3" id="slot-ben">Bénéficiaire</span>, 
                permettant ainsi de restaurer la capacité de transmission en 
                <span class="text-success fw-bold" id="slot-year">....</span>
            </h4>
        </div>
    </div>

    {# --- SECTION 2 : LES CARTES BÉNÉFICIAIRES --- #}
    <div class="row g-4">
        {% for benId, group in groupedPlan %}
            {# On récupère le nom du premier donateur pour le texte par défaut #}
            {% set firstDonor = group.items[0].donor.firstname %}
            
            <div class="col-md-6 col-xl-4">
                <div class="card beneficiary-card border-0 shadow-sm rounded-5 bg-dark p-4 h-100" 
                     style="cursor: pointer; transition: 0.3s;"
                     data-ben="{{ group.name }}"
                     data-donor="{{ firstDonor }}">
                    
                    <div class="text-center mb-4">
                        <h5 class="fw-black text-white mb-1">{{ group.name }}</h5>
                        <span class="badge bg-primary bg-opacity-20 text-primary x-small rounded-pill">{{ group.rel|replace({'_': ' '}) }}</span>
                    </div>

                    {# Réservoirs avec zone de taxe #}
                    <div class="d-flex align-items-end justify-content-center position-relative mb-4" style="height: 150px;">
                        <div class="position-absolute w-100" style="bottom: 110px; border-top: 2px dashed #ff4d4d; opacity: 0.4;"></div>
                        
                        <div class="mx-2 text-center" style="width: 50px;">
                            <div class="bg-primary rounded-top" style="height: {{ (group.items[0].available / 1000) }}px;"></div>
                            <div class="x-small text-white opacity-50 mt-2">Légal</div>
                        </div>
                        {# Affichage Sarkozy si présent #}
                        {% for op in group.items %}
                            {% if 'sarkozy' in op.type %}
                                <div class="mx-2 text-center" style="width: 50px;">
                                    <div class="bg-warning rounded-top" style="height: {{ (op.available / 1000) }}px;"></div>
                                    <div class="x-small text-white opacity-50 mt-2">Argent</div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>

    {# FOOTER SUPPORT #}
    <footer class="mt-5 pt-4 border-top d-flex justify-content-between text-muted x-small">
        <div><i class="fas fa-shield-alt me-2"></i>Détails sécurisés & Archivage Notaire</div>
        <div>{{ currentYear }} © Stratégie Patrimoniale</div>
    </footer>
</div>

<style>
    .fw-black { font-weight: 900; }
    .x-small { font-size: 0.65rem; }
    .rounded-5 { border-radius: 2rem !important; }
    .bg-dark { background-color: #0f1113 !important; }
    .card-active { transform: translateY(-10px); box-shadow: 0 1rem 3rem rgba(0,0,0,0.175)!important; border: 1px solid #0d6efd !important; }
    #slot-donor, #slot-ben { transition: all 0.3s ease; min-width: 120px; display: inline-block; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const cards = document.querySelectorAll('.beneficiary-card');
    const slotDonor = document.getElementById('slot-donor');
    const slotBen = document.getElementById('slot-ben');
    const slotYear = document.getElementById('slot-year');
    const progress = document.getElementById('timeline-progress');
    const stepMid = document.getElementById('step-mid');
    const stepEnd = document.getElementById('step-end');

    cards.forEach(card => {
        card.addEventListener('mouseenter', () => {
            const ben = card.getAttribute('data-ben');
            const donor = card.getAttribute('data-donor');

            // Mise à jour du texte à trous
            slotDonor.innerText = donor;
            slotDonor.classList.replace('bg-white', 'bg-primary');
            slotDonor.classList.replace('text-primary', 'text-white');
            
            slotBen.innerText = ben;
            slotBen.classList.replace('bg-white', 'bg-primary');
            slotBen.classList.replace('text-primary', 'text-white');

            slotYear.innerText = "{{ rechargeYear }}";

            // Animation frise
            progress.style.width = "100%";
            stepMid.classList.replace('bg-light', 'bg-primary');
            stepMid.classList.replace('text-muted', 'text-white');
            stepEnd.classList.replace('bg-light', 'bg-success');
            stepEnd.classList.replace('text-muted', 'text-white');

            card.classList.add('card-active');
        });

        card.addEventListener('mouseleave', () => {
            // Reset
            slotDonor.innerText = "Donateur";
            slotDonor.classList.replace('bg-primary', 'bg-white');
            slotDonor.classList.replace('text-white', 'text-primary');

            slotBen.innerText = "Bénéficiaire";
            slotBen.classList.replace('bg-primary', 'bg-white');
            slotBen.classList.replace('text-white', 'text-primary');

            slotYear.innerText = "....";

            progress.style.width = "0%";
            stepMid.classList.replace('bg-primary', 'bg-light');
            stepMid.classList.replace('text-white', 'text-muted');
            stepEnd.classList.replace('bg-success', 'bg-light');
            stepEnd.classList.replace('text-white', 'text-muted');

            card.classList.remove('card-active');
        });
    });
});
</script>
{% endblock %}