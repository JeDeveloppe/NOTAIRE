{# templates/family/person/_form.html.twig #}
{{ form_start(form) }}

<div class="row g-3 mb-4">
    <div class="col-12">
        <h5 class="text-muted small fw-bold text-uppercase ls-wide border-bottom pb-2">État Civil</h5>
    </div>

    <div class="col-md-6">
        <label class="form-label small fw-bold text-muted">{{ form_label(form.firstname) }}</label>
        {{ form_widget(form.firstname, {'attr': {'class': 'form-control rounded-3'}}) }}
        {{ form_errors(form.firstname) }}
    </div>

    <div class="col-md-6">
        <label class="form-label small fw-bold text-muted">{{ form_label(form.lastname) }}</label>
        {{ form_widget(form.lastname, {'attr': {'class': 'form-control rounded-3 text-uppercase'}}) }}
        {{ form_errors(form.lastname) }}
    </div>

    <div class="col-md-6">
        <label class="form-label small fw-bold text-muted">{{ form_label(form.birthdate) }}</label>
        {{ form_widget(form.birthdate, {'attr': {'class': 'form-control rounded-3'}}) }}
        {{ form_errors(form.birthdate) }}
    </div>

    <div class="col-md-6">
        <label class="form-label small fw-bold text-muted d-block">Genre / Civilité</label>
        <div class="gender-inline-wrapper border rounded-3 p-2 bg-white d-flex gap-4 h-100 align-items-center">
            {% for child in form.gender %}
                <div class="form-check form-check-inline mb-0 ms-2">
                    {{ form_widget(child, {'attr': {'class': 'form-check-input'}}) }}
                    {{ form_label(child, null, {'label_attr': {'class': 'form-check-label small'}}) }}
                </div>
            {% endfor %}
        </div>
    </div>
</div>

{# Blocs Conditionnels avec calcul de visibilité #}
{% if not is_first %}
    {# On vérifie s'il y a réellement des gens à choisir #}
    {% set has_parents = form.parents is defined and form.parents.vars.choices|length > 0 %}
    {% set has_children = form.children is defined and form.children.vars.choices|length > 0 %}

    {% if has_parents or has_children or form.deathDate is defined %}
        <div class="row g-3 mb-4">
            <div class="col-12">
                <h5 class="text-muted small fw-bold text-uppercase ls-wide border-bottom pb-2">Généalogie</h5>
            </div>

            {% if form.deathDate is defined %}
                <div class="col-12 mb-2">
                    <label class="form-label small fw-bold text-muted">{{ form_label(form.deathDate) }}</label>
                    {{ form_widget(form.deathDate, {'attr': {'class': 'form-control rounded-3'}}) }}
                </div>
            {% endif %}

            {# Affichage dynamique des Parents #}
            {% if has_parents %}
                <div class="{{ has_children ? 'col-md-6' : 'col-12' }}">
                    <div class="p-3 bg-light rounded-4 border border-light-subtle h-100">
                        <label class="form-label small fw-bold text-indigo d-block mb-3">
                            <i class="fas fa-users-rays me-2"></i>Parents possibles
                        </label>
                        <div class="relation-scroll-area" style="max-height: 200px; overflow-y: auto;">
                            {% for parent_choice in form.parents %}
                                <div class="form-check custom-relation-check mb-2">
                                    {{ form_widget(parent_choice, {'attr': {'class': 'form-check-input'}}) }}
                                    {{ form_label(parent_choice, null, {'label_attr': {'class': 'form-check-label small'}}) }}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            {% endif %}

            {# Affichage dynamique des Enfants #}
            {% if has_children %}
                <div class="{{ has_parents ? 'col-md-6' : 'col-12' }}">
                    <div class="p-3 bg-light rounded-4 border border-light-subtle h-100">
                        <label class="form-label small fw-bold text-indigo d-block mb-3">
                            <i class="fas fa-children me-2"></i>Enfants possibles
                        </label>
                        <div class="relation-scroll-area" style="max-height: 200px; overflow-y: auto;">
                            {% for child_choice in form.children %}
                                <div class="form-check custom-relation-check mb-2">
                                    {{ form_widget(child_choice, {'attr': {'class': 'form-check-input'}}) }}
                                    {{ form_label(child_choice, null, {'label_attr': {'class': 'form-check-label small'}}) }}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    {% endif %}
{% endif %}

<div class="pt-4">
    {{ form_widget(form._token) }}
    <button type="submit" class="{{ button_class|default('btn btn-primary btn-lg w-100 rounded-4 shadow-sm') }}">
        <i class="fas fa-save me-2"></i>{{ button_label|default('Enregistrer') }}
    </button>
</div>

{{ form_end(form, {render_rest: false}) }}

<style>
    .ls-wide { letter-spacing: 0.05em; }
    .text-indigo { color: #4f46e5; }
    .bg-light-subtle { background-color: #f8fafc; }
    .custom-relation-check .form-check-input:checked {
        background-color: #4f46e5;
        border-color: #4f46e5;
    }
    .relation-scroll-area::-webkit-scrollbar { width: 4px; }
    .relation-scroll-area::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
</style>