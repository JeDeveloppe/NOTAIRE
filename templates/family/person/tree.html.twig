{% extends 'base.html.twig' %}

{% block title %}Bilan des plafonds de:
	{{ person.firstname }}
	{{ person.lastname|upper }}
{% endblock %}

{% block body %}
	<div
		class="notary-app container-fluid py-4 bg-light min-vh-100">

		{# --- HEADER --- #}
		<div class="container">
<div class="d-flex justify-content-between align-items-center mb-5 bg-white p-4 rounded-4 shadow-sm border-0 position-relative overflow-hidden">
    {# Accent vertical pour le statut #}
    <div class="position-absolute start-0 top-0 bottom-0 bg-{{ person.deceased ? 'secondary' : 'primary' }}" style="width: 5px; opacity: 0.8;"></div>

    <div class="d-flex align-items-center">
        {# Avatar avec initiale #}
		{% include "components/person/_avatar_with_initial.html.twig" with { 'person': person } %}

        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-1">
                    <li class="breadcrumb-item small">
                        <a href="{{ path('app_family_dashboard') }}" class="text-decoration-none text-muted">
                            <i class="fas fa-users me-1"></i>Membres de la famille
                        </a>
                    </li>
                    <li class="breadcrumb-item active small fw-semibold text-primary" aria-current="page">Bilan individuel</li>
                </ol>
            </nav>
            
            <h1 class="h3 fw-bold mb-1 text-dark d-flex align-items-center">
                {{ person.firstname }} {{ person.lastname|upper }}
                {% include "components/person/_genderIcon.html.twig" %}
            </h1>

            <div class="d-flex align-items-center gap-2">
                {# Statut Vie/Décès et Âge #}
                {% include "components/person/_age_status_live.html.twig" %}
            </div>
        </div>
    </div>

    {# Bloc de résultat financier (Scorecard) #}
    <div class="text-end p-3 rounded-4 bg-light border border-white shadow-sm" style="min-width: 240px; background: linear-gradient(145deg, #ffffff, #f8fafc);">
        <div class="text-muted small text-uppercase fw-bold mb-1" style="font-size: 0.6rem; letter-spacing: 1.5px; opacity: 0.8;">
            Capacité de transmission
        </div>
        <div class="h2 fw-bold text-success mb-0">
            {{ totalGlobal|number_format(0, ',', ' ') }}
            <span class="ms-1 h5 mb-0 opacity-75">€</span>
        </div>
        <div class="mt-2 d-flex align-items-center justify-content-end gap-2">
            <span class="small text-muted" style="font-size: 0.7rem;">Optimisation maximale</span>
            <div class="spinner-grow spinner-grow-sm text-success" role="status" style="width: 8px; height: 8px;"></div>
        </div>
    </div>
</div>

			{# --- VISUALISATION DE LA LIGNÉE (ARBRE) --- #}
			<div class="card border-0 shadow-sm rounded-4 mb-4 overflow-hidden">
				<div class="card-header bg-white border-0 pt-4 px-4">
					<h3 class="h6 fw-bold mb-0 text-secondary">
						<i class="fas fa-sitemap me-2 text-primary"></i>Position dans la lignée familiale</h3>
				</div>
				<div class="card-body bg-white p-4">
					<div class="family-tree-container">
						<div
							class="tree-grid">
							{# NIVEAU N-1 (Parents) #}
							<div class="tree-level">
								{% for parent in person.parents %}
									<a href="{{ path('app_person_tree', {id: parent.id}) }}" class="text-decoration-none">
										<div class="tree-node parent">
											<span class="node-label">PARENT</span>
											<span class="node-name">
												<i class="fas {{ parent.genderIcon }} me-1" style="font-size: 0.7rem;"></i>
												{{ parent.firstname }}
											</span>
										</div>
									</a>
								{% endfor %}
							</div>

							<div class="tree-connector">
								<i class="fas fa-chevron-down text-light opacity-50"></i>
							</div>

							{# NIVEAU 0 (L'individu sélectionné) #}
							<div class="tree-level">
								<div class="tree-node focus shadow-sm">
									<span class="node-label">CIBLE ANALYSÉE</span>
									<span class="node-name text-primary">
										<i class="fas {{ person.genderIcon }} me-1"></i>
										{{ person.firstname }}
										{{ person.lastname|upper }}
									</span>
								</div>
							</div>

							<div class="tree-connector">
								<i class="fas fa-chevron-down text-light opacity-50"></i>
							</div>

							{# NIVEAU N+1 (Enfants) #}
							<div class="tree-level">
								{% for child in person.children %}
									<a href="{{ path('app_person_tree', {id: child.id}) }}" class="text-decoration-none">
										<div class="tree-node child">
											<span class="node-label">ENFANT</span>
											<span class="node-name">
												<i class="fas {{ child.genderIcon }} me-1" style="font-size: 0.7rem;"></i>
												{{ child.firstname }}
											</span>
										</div>
									</a>
								{% else %}
									<span class="text-muted small italic p-2">Aucun descendant direct enregistré</span>
								{% endfor %}
							</div>
						</div>
					</div>
				</div>
			</div>

			{# --- ANALYSE DES PLAFONDS (FLUX) --- #}
			<div
				class="row g-4">
				{# COLONNE RÉCEPTIONS #}
				<div class="col-lg-6">
					<div class="card border-0 shadow-sm rounded-4 h-100">
						<div class="card-header bg-white border-0 pt-4 px-4 d-flex align-items-center">
							<div class="icon-circle bg-info-subtle text-info me-3 shadow-sm">
								<i class="fas fa-arrow-down"></i>
							</div>
							<div>
								<h2 class="h5 fw-bold mb-0">Réceptions possibles</h2>
								<p class="text-muted small mb-0">Sommes pouvant être reçues sans droits</p>
							</div>
						</div>
						<div class="card-body px-4">
							<div class="accordion accordion-flush" id="parentIn">
								{% for sim in receivedSimulations %}
									{{ _self.render_card(sim, 'in', loop.index) }}
								{% else %}
									<div class="text-center py-4">
										<p class="text-muted small italic">Aucun ascendant direct trouvé pour simuler une réception.</p>
									</div>
								{% endfor %}
							</div>
						</div>
					</div>
				</div>

				{# COLONNE TRANSMISSIONS #}
				<div class="col-lg-6">
					<div class="card border-0 shadow-sm rounded-4 h-100">
						<div class="card-header bg-white border-0 pt-4 px-4 d-flex align-items-center">
							<div class="icon-circle bg-success-subtle text-success me-3 shadow-sm">
								<i class="fas fa-paper-plane"></i>
							</div>
							<div>
								<h2 class="h5 fw-bold mb-0">Transmissions possibles</h2>
								<p class="text-muted small mb-0">Optimisation de votre succession</p>
							</div>
						</div>
						<div class="card-body px-4">
							<div class="accordion accordion-flush" id="parentOut">
								{% for sim in givenSimulations %}
									{{ _self.render_card(sim, 'out', loop.index) }}
								{% else %}
									<div class="text-center py-4">
										<p class="text-muted small italic">Aucun bénéficiaire (enfant, petit-enfant...) éligible.</p>
									</div>
								{% endfor %}
							</div>
						</div>
					</div>
				</div>
			</div>

			{# --- REGISTRE DES ACTES (HISTORIQUE RÉEL) --- #}
			<div class="card border-0 shadow-sm rounded-4 mt-5 overflow-hidden border-top border-4 border-dark">
				<div class="card-header bg-white py-3 px-4 d-flex justify-content-between align-items-center border-bottom">
					<h3 class="h6 fw-bold mb-0"><i class="fas fa-history me-2 text-dark"></i>REGISTRE CHRONOLOGIQUE DES ACTES</h3>
					<span class="badge bg-dark text-white rounded-pill">{{ (history_given|length + history_received|length) }} acte(s)</span>
                    {% include "components/buttons/_add_donation.html.twig" %}
				</div>
				<div class="table-responsive">
					<table class="table table-hover align-middle mb-0">
						<thead class="bg-light">
							<tr class="small text-muted" style="font-size: 0.7rem; letter-spacing: 0.5px;">
								<th class="ps-4 py-3">DATE DE L'ACTE</th>
								<th>NATURE DU FLUX</th>
								<th>TIERS CONCERNÉ</th>
								<th class="text-end">MONTANT BRUT</th>
								<th class="text-end pe-4">DROITS PAYÉS</th>
							</tr>
						</thead>
						<tbody>
							{% set allActs = history_given|merge(history_received)|sort((a, b) => b.createdAt <=> a.createdAt) %}
							{% for act in allActs %}
								{% set isGiver = act.donor.id == person.id %}
								<tr>
									<td class="ps-4 small text-secondary">{{ act.createdAt|date('d/m/Y') }}</td>
									<td>
										<span class="badge {{ isGiver ? 'bg-danger-subtle text-danger' : 'bg-success-subtle text-success' }} rounded-pill border-0 px-3">
											<i class="fas {{ isGiver ? 'fa-minus' : 'fa-plus' }} me-1"></i>
											{{ isGiver ? 'DONNÉ' : 'REÇU' }}
										</span>
									</td>
									<td class="small fw-bold text-dark">{{ isGiver ? act.beneficiary.firstname : act.donor.firstname }}</td>
									<td class="text-end fw-bold text-dark">{{ act.amount|number_format(0, ',', ' ') }}
										€</td>
									<td class="text-end pe-4">
										{% if act.taxPaid > 0 %}
											<span class="text-danger fw-bold small">{{ act.taxPaid|number_format(0, ',', ' ') }}
												€</span>
										{% else %}
											<span class="text-muted small">Exonéré (0 €)</span>
										{% endif %}
									</td>
								</tr>
							{% else %}
								<tr>
									<td colspan="5" class="text-center py-5">
										<div class="text-muted">
											<i class="fas fa-folder-open fa-2x mb-3 opacity-25"></i>
											<p class="small italic mb-0">Aucune donation passée n'a été enregistrée pour ce profil.</p>
										</div>
									</td>
								</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>

	{# --- MACRO RENDU DES CARTES DE SIMULATION --- #}
	{% macro render_card(sim, type, index) %}
		<div class="accordion-item border-0 border-bottom">
			<h2 class="accordion-header">
				<button class="accordion-button collapsed px-0 bg-transparent py-4 shadow-none" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ type }}{{ index }}">
					<div class="d-flex justify-content-between w-100 align-items-center pe-3">
						<div class="d-flex align-items-center">
							<div class="avatar-circle bg-light text-dark fw-bold me-3 shadow-sm" style="width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem;">
								{{ (type == 'in' ? sim.donor.firstname : sim.beneficiary.firstname)|first|upper }}
							</div>
							<div>
								<span class="d-block small text-primary fw-bold text-uppercase" style="font-size: 0.6rem; letter-spacing: 0.5px;">{{ sim.relationship_code|replace({'_': ' '}) }}</span>
								<span class="fw-bold text-dark">{{ type == 'in' ? sim.donor.firstname : sim.beneficiary.firstname }}</span>
							</div>
						</div>
						<div class="text-end">
							<span class="d-block small text-muted" style="font-size: 0.6rem;">DISPONIBLE IMMÉDIAT</span>
							<span class="badge bg-white text-success border-success border fw-bold" style="font-size: 0.9rem;">{{ sim.total_allowance|number_format(0, ',', ' ') }}
								€</span>
						</div>
					</div>
				</button>
			</h2>
			<div id="collapse{{ type }}{{ index }}" class="accordion-collapse collapse" data-bs-parent="#parent{{ type }}">
				<div class="accordion-body bg-light rounded-4 mb-3 p-4">
					<h6 class="small fw-bold text-uppercase text-muted mb-3" style="font-size: 0.65rem;">Détail des dispositifs fiscaux</h6>
					{% for rule in sim.rules %}
						<div class="mb-3 p-3 bg-white rounded-3 border-start border-4 {{ rule.is_valid ? 'border-primary' : 'border-secondary opacity-50' }} shadow-sm">
							<div class="d-flex justify-content-between align-items-start mb-2">
								<div class="pe-3">
									<span class="d-block fw-bold text-dark" style="font-size: 0.85rem;">{{ rule.label }}</span>
									{% if not rule.is_valid %}
										<div class="d-flex align-items-center text-danger mt-1">
											<i class="fas fa-times-circle me-1" style="font-size: 0.7rem;"></i>
											<span class="italic small" style="font-size: 0.7rem;">{{ rule.reason }}</span>
										</div>
									{% endif %}
								</div>
								<div class="text-end">
									<span class="h6 fw-bold mb-0 {{ rule.is_valid ? 'text-primary' : 'text-muted' }}">
										{{ rule.available|number_format(0, ',', ' ') }}
										€
									</span>
								</div>
							</div>

							{% if rule.is_valid %}
								{% set pct = (rule.consumed / rule.max_allowance * 100)|default(0) %}
								<div class="progress bg-light" style="height: 6px; border-radius: 10px;">
									<div class="progress-bar rounded-pill {{ pct >= 90 ? 'bg-warning' : 'bg-primary' }}" style="width: {{ pct > 100 ? 100 : pct }}%"></div>
								</div>
								<div class="d-flex justify-content-between mt-2" style="font-size: 0.65rem; color: #64748b;">
									<span>Utilisé :
										<strong>{{ rule.consumed|number_format(0, ',', ' ') }}
											€</strong>
									</span>
									<span>Plafond :
										{{ rule.max_allowance|number_format(0, ',', ' ') }}
										€</span>
								</div>
							{% endif %}
						</div>
					{% endfor %}
				</div>
			</div>
		</div>
	{% endmacro %}

	<style>
		/* Global Styles */
		.notary-app {
			color: #1e293b;
		}
		.icon-circle {
			width: 42px;
			height: 42px;
			border-radius: 12px;
			display: flex;
			align-items: center;
			justify-content: center;
		}
		.bg-light {
			background-color: #f8fafc !important;
		}

		/* Family Tree Styling */
		.family-tree-container {
			display: flex;
			justify-content: center;
			padding: 10px 0;
		}
		.tree-grid {
			display: flex;
			flex-direction: column;
			align-items: center;
			gap: 5px;
			width: 100%;
		}
		.tree-level {
			display: flex;
			justify-content: center;
			gap: 15px;
			width: 100%;
			flex-wrap: wrap;
		}
		.tree-node {
			min-width: 150px;
			padding: 12px;
			background: white;
			border: 1px solid #e2e8f0;
			border-radius: 16px;
			text-align: center;
			display: flex;
			flex-direction: column;
			transition: all 0.2s;
		}
		.tree-node:hover {
			border-color: #94a3b8;
			transform: translateY(-2px);
		}
		.node-label {
			font-size: 0.55rem;
			font-weight: 800;
			color: #94a3b8;
			text-transform: uppercase;
			letter-spacing: 1px;
			margin-bottom: 2px;
		}
		.node-name {
			font-size: 0.85rem;
			font-weight: 700;
			color: #1e293b;
		}

		.tree-node.focus {
			border: 2px solid #2563eb;
			background: #f0f7ff;
			transform: scale(1.05);
		}
		.tree-node.focus .node-label {
			color: #2563eb;
		}
		.tree-node.parent {
			border-top: 4px solid #3b82f6;
		}
		.tree-node.child {
			border-top: 4px solid #10b981;
		}
		.tree-connector {
			height: 25px;
			display: flex;
			align-items: center;
		}

		/* Accordion & Progress */
		.accordion-button:not(.collapsed) {
			color: #2563eb;
			font-weight: bold;
		}
		.progress-bar {
			transition: width 0.6s ease;
		}

		/* Table styling */
		.table thead th {
			border-top: none;
			padding-bottom: 15px;
		}
		.badge {
			font-weight: 600;
			padding: 0.5em 1em;
		}
	</style>
{% endblock %}
