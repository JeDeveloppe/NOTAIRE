{# templates/notary/subscription/subscribe_choice.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}Configuration de votre étude - Lignée{% endblock %}

{% block body %}
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-xl-10">

                {# HEADER TITRE #}
                <div class="text-center mb-5">
                    <span class="badge bg-indigo-brand-subtle text-indigo-brand rounded-pill px-3 py-2 mb-3 fw-bold">
                        {{ hasMainOffer ? 'Évolutions' : 'Étape finale' }}
                    </span>
                    <h1 class="fw-black h2 text-dark">
                        {{ hasMainOffer ? 'Optimisez votre visibilité' : 'Configuration de votre étude' }}
                    </h1>
                    <p class="text-muted mx-auto" style="max-width: 600px;">
                        {{ hasMainOffer 
                            ? 'Ajoutez des secteurs supplémentaires pour recevoir davantage de dossiers qualifiés.' 
                            : 'Personnalisez votre périmètre d’intervention et activez la réception de vos dossiers en temps réel.' 
                        }}
                    </p>
                </div>

                <form action="" method="POST" id="subscribe-form">
                    <div class="card border-0 shadow-lg rounded-4 overflow-hidden">
                        <div class="card-body p-0">

                            {# 1. CHOIX DU FORFAIT OU RÉCAPITULATIF SI DÉJÀ ACTIF #}
                            <div class="p-4 p-md-5 bg-white border-bottom">
                                <div class="d-flex align-items-center mb-4">
                                    <div class="step-number me-3">1</div>
                                    <h5 class="fw-bold mb-0 text-dark">Votre forfait de base</h5>
                                </div>
                                
                                {% if hasMainOffer %}
                                    {# Affichage si déjà abonné #}
                                    <div class="d-flex align-items-center p-4 rounded-4 border-2 border-dashed bg-light" style="border: 2px dashed #e2e8f0;">
                                        <div class="icon-circle bg-indigo-brand text-white me-3 p-3 rounded-circle">
                                            <i class="bi bi-patch-check-fill fs-4"></i>
                                        </div>
                                        <div>
                                            <span class="text-uppercase smaller fw-bold text-muted d-block">Abonnement actuel</span>
                                            <h6 class="fw-bold mb-0 text-dark">{{ activeSubscription.offer.name }} ({{ activeSubscription.offer.baseNotariesCount }} CP inclus)</h6>
                                        </div>
                                        <div class="ms-auto text-end">
                                            <span class="badge bg-white text-indigo-brand border border-indigo-brand-subtle rounded-pill">Actif</span>
                                        </div>
                                        {# Input caché pour que le JS ne casse pas s'il cherche un main_offer (optionnel selon ton back) #}
                                        <input type="hidden" name="current_offer_id" value="{{ activeSubscription.offer.id }}">
                                    </div>
                                {% else %}
                                    {# Choix initial du forfait #}
                                    <div class="row g-3">
                                        {% for offer in mainOffers %}
                                            <div class="col-md-4">
                                                <input type="radio" name="main_offer" id="offer_{{ offer.id }}" value="{{ offer.id }}" 
                                                       data-price="{{ offer.currentPrice.amountHt|default(0) }}" 
                                                       class="btn-check plan-input" 
                                                       {% if preselectedId == offer.id %} checked {% endif %} required>
                                                <label class="card h-100 border-2 rounded-4 p-4 selection-card position-relative" for="offer_{{ offer.id }}">
                                                    <div class="check-icon position-absolute top-0 end-0 m-2 opacity-0 text-indigo-brand">
                                                        <i class="bi bi-check-circle-fill fs-5"></i>
                                                    </div>
                                                    <span class="text-uppercase text-muted smaller fw-bold tracking-widest d-block mb-2">{{ offer.name }}</span>
                                                    <div class="d-flex align-items-baseline mb-3">
                                                        <span class="h2 fw-black text-dark mb-0">
                                                            {{ (offer.currentPrice.amountHt / 100)|number_format(0, ',', ' ') }}€
                                                        </span>
                                                        <span class="text-muted ms-1 small">HT/mois</span>
                                                    </div>
                                                    <div class="mt-auto pt-3 border-top">
                                                        <i class="bi bi-geo-alt-fill text-indigo-brand me-1"></i>
                                                        <span class="fw-bold text-dark">{{ offer.baseNotariesCount }}</span> 
                                                        <span class="text-muted small">codes inclus</span>
                                                    </div>
                                                </label>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>

                            {# 2. EXTENSIONS TERRITORIALES #}
                            <div class="p-4 p-md-5 bg-light-subtle border-bottom">
                                <div class="d-flex align-items-center mb-4">
                                    <div class="step-number me-3">2</div>
                                    <h5 class="fw-bold mb-0 text-dark">
                                        {{ hasMainOffer ? 'Ajouter des codes postaux' : 'Extension de votre périmètre' }}
                                        <small class="text-muted fw-normal ms-2">(Optionnel)</small>
                                    </h5>
                                </div>
                                
                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <input type="radio" name="addon_selection" value="none" data-price="0" id="addon_none" class="btn-check addon-input" checked>
                                        <label class="addon-box d-flex flex-column h-100 p-3" for="addon_none">
                                            <span class="fw-bold text-dark mb-1 small">Aucun ajout</span>
                                            <p class="smaller text-muted mb-3 flex-grow-1">Conserver le quota de mon forfait actuel.</p>
                                            <div class="mt-auto pt-2 border-top fw-bold smaller text-muted">Inclus</div>
                                        </label>
                                    </div>

                                    {% for addon in addons %}
                                        {% set nb = addon.baseNotariesCount %}
                                        <div class="col-md-3">
                                            <input type="radio" name="addon_selection" value="{{ addon.id }}" 
                                                   data-price="{{ addon.currentPrice.amountHt|default(0) }}" 
                                                   id="addon_{{ addon.id }}" class="btn-check addon-input">
                                            <label class="addon-box d-flex flex-column h-100 p-3" for="addon_{{ addon.id }}">
                                                <span class="fw-bold text-dark mb-1 small">+{{ nb }} Secteur{{ nb > 1 ? 's' : '' }}</span>
                                                <p class="smaller text-muted mb-3 flex-grow-1">Augmentez votre zone de {{ nb }} CP.</p>
                                                <div class="mt-auto pt-2 border-top fw-bold text-indigo-brand small">
                                                    +{{ (addon.currentPrice.amountHt / 100)|number_format(2, ',', ' ') }}€ <small class="fw-normal">HT</small>
                                                </div>
                                            </label>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>

                            {# BLOC GARANTIE #}
                            <div class="p-4 p-md-5 bg-white border-bottom">
                                <div class="row align-items-center g-4">
                                    <div class="col-md-2 text-center">
                                        <i class="bi bi-shield-check text-success" style="font-size: 3.5rem;"></i>
                                    </div>
                                    <div class="col-md-10 border-start-md ps-md-4">
                                        <h6 class="fw-bold text-dark mb-2">Engagement "Flux Garanti" Lignée</h6>
                                        <p class="text-muted small mb-0">
                                            Si votre zone génère moins de 5 simulations/mois, nous créditons votre compte de 80% du forfait. 
                                            <span class="fw-medium text-indigo-brand">Présence digitale sans risque financier.</span>
                                        </p>
                                    </div>
                                </div>
                            </div>

                            {# 3. FOOTER : TOTAL & ACTION #}
                            <div class="bg-dark p-4 p-md-5">
                                <div class="row align-items-center">
                                    <div class="col-md-7 mb-4 mb-md-0">
                                        <span class="text-white-50 small text-uppercase fw-bold tracking-widest d-block mb-1">
                                            {{ hasMainOffer ? 'Supplément à régler' : 'Votre investissement mensuel' }}
                                        </span>
                                        <div class="h1 fw-black text-white mb-0">
                                            <span id="total-price">0,00</span>€
                                            <small class="fs-5 fw-normal opacity-50">HT</small>
                                        </div>
                                    </div>

                                    <div class="col-md-5 text-md-end">
                                        <button type="submit" class="btn btn-indigo-brand btn-lg rounded-pill px-5 py-3 fw-bold shadow-lg w-100">
                                            {{ hasMainOffer ? 'Valider l\'extension' : 'Procéder au paiement' }}
                                            <i class="bi bi-arrow-right ms-2"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <style>
        :root { --indigo-brand: #6366f1; --indigo-brand-subtle: rgba(99, 102, 241, 0.1); }
        .fw-black { font-weight: 900; }
        .text-indigo-brand { color: var(--indigo-brand) !important; }
        .step-number { width: 28px; height: 28px; background: var(--indigo-brand); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.8rem; }
        .btn-indigo-brand { background-color: var(--indigo-brand); color: white; border: none; transition: 0.3s; }
        .btn-indigo-brand:hover { background-color: #4f46e5; transform: translateY(-3px); color: white; box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3); }
        .selection-card { cursor: pointer; border: 2px solid #f1f5f9; transition: all 0.3s ease; background: white; }
        .btn-check:checked + .selection-card { border-color: var(--indigo-brand); background: #fcfcff; }
        .btn-check:checked + .selection-card .check-icon { opacity: 1; }
        .addon-box { border: 2px solid #f1f5f9; border-radius: 16px; transition: 0.2s; background: white; cursor: pointer; min-height: 120px; }
        .btn-check:checked + .addon-box { border-color: var(--indigo-brand); background-color: #fcfcff; }
        .smaller { font-size: 0.75rem; }
        .tracking-widest { letter-spacing: 0.1em; }
        @media (min-width: 768px) { .border-start-md { border-left: 1px solid #dee2e6 !important; } }
    </style>

    <script>
        document.addEventListener('turbo:load', function () {
            const inputs = document.querySelectorAll('.plan-input, .addon-input');
            const totalDisplay = document.getElementById('total-price');
            if (!totalDisplay) return;

            function calculate() {
                let totalCents = 0;
                inputs.forEach(i => {
                    if (i.checked) totalCents += Number(i.dataset.price || 0);
                });

                totalDisplay.innerText = (totalCents / 100).toLocaleString('fr-FR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            }

            inputs.forEach(i => i.addEventListener('change', calculate));
            calculate();
        });
    </script>
{% endblock %}