{# templates/notary/subscribe_choice.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}Votre Configuration
{% endblock %}

{% block body %}
	<div class="container py-5">
		<div class="row justify-content-center">
			<div class="col-xl-10">

				<div class="text-center mb-5">
					<h1 class="fw-black h2">Configuration de votre étude</h1>
					<p class="text-muted">Personnalisez votre visibilité sur la plateforme Lignée</p>
				</div>

				<form
					action="" method="POST" id="subscribe-form">
					{# LA MASTER CARD #}
					<div class="card border-0 shadow-lg rounded-4 overflow-hidden">
						<div
							class="card-body p-0">

							{# 1. HEADER / FORFAITS #}
							<div class="p-4 p-md-5 bg-light-subtle border-bottom">
								<h5 class="fw-bold mb-4 d-flex align-items-center">
									<span class="badge bg-indigo-brand me-2">1</span>
									Choisissez votre forfait
								</h5>
								<div class="row g-3">
									{% for offer in mainOffers %}
										<div class="col-md-4">
											<input type="radio" name="main_offer" id="offer_{{ offer.id }}" value="{{ offer.id }}" data-price="{{ offer.currentPrice.amountHt|default(0) }}" class="btn-check plan-input" {% if preselectedId == offer.id %} checked {% endif %} required>
											<label class="card h-100 border-2 rounded-3 p-3 selection-card" for="offer_{{ offer.id }}">
												<span class="fw-bold d-block mb-1">{{ offer.name }}</span>
												<span class="h4 fw-black text-indigo-brand mb-0">
													{{ (offer.currentPrice.amountHt / 100)|number_format(2, ',', ' ') }}€
												</span>
												<span class="text-muted d-block small mt-2">
													{{ offer.baseSectorsCount }}
													codes postaux
												</span>
											</label>
										</div>
									{% endfor %}
								</div>
							</div>

							{# 2. OPTIONS / ADD-ONS #}
							<div class="p-4 p-md-5">
								<h5 class="fw-bold mb-4 d-flex align-items-center">
									<span class="badge bg-indigo-brand me-2">2</span>
									Codes postaux additionnels
								</h5>
								<div class="addon-grid">
									<div class="addon-item">
										<input type="radio" name="addon_selection" value="none" data-price="0" id="addon_none" class="btn-check addon-input" checked>
										<label class="addon-box" for="addon_none">
											<span class="fw-bold">Forfait standard</span>
											<small class="d-block text-muted">Aucun ajout</small>
										</label>
									</div>
									{% for addon in addons %}
										<div class="addon-item">
											<input type="radio" name="addon_selection" value="{{ addon.id }}" data-price="{{ addon.currentPrice.amountHt|default(0) }}" id="addon_{{ addon.id }}" class="btn-check addon-input">
											<label class="addon-box" for="addon_{{ addon.id }}">
												{% set codes = "code" %}
												{% if  addon.baseSectorsCount > 1 %}
													{% set codes = "codes" %}
												{% endif %}

												<span class="fw-bold">+{{ addon.baseSectorsCount }}
													{{ codes }}</span>
												<small class="d-block text-indigo-brand">+{{ (addon.currentPrice.amountHt / 100)|number_format(2, ',', ' ') }}€</small>
											</label>
										</div>
									{% endfor %}
								</div>
							</div>

							{# 3. FOOTER DE LA CARTE (TOTAL & PAIEMENT) #}
							<div class="bg-dark p-4 p-md-5">
								<div class="row align-items-center">
									<div class="col-md-7 mb-4 mb-md-0">
										<div class="d-flex align-items-center mb-1">
											<span class="text-white-50 small text-uppercase fw-bold tracking-wider">Votre investissement mensuel</span>
											<span class="ms-3 badge bg-success-subtle text-success border border-success-subtle rounded-pill x-small">
												<i class="fas fa-unlock me-1"></i>
												Liberté totale
											</span>
										</div>

										<div class="h1 fw-black text-white mb-0">
											<span id="total-price">0,00</span>€
											<small class="fs-5 fw-normal opacity-50">HT</small>
										</div>

										<div class="mt-3 d-flex flex-wrap gap-3">
											<div class="text-white-50 x-small">
												<i class="fas fa-check text-indigo-brand me-1"></i>
												<strong>Zéro engagement :</strong>
												Arrêtez quand vous voulez.
											</div>
											<div class="text-white-50 x-small">
												<i class="fas fa-check text-indigo-brand me-1"></i>
												<strong>Évolutif :</strong>
												Changez de zone chaque mois.
											</div>
										</div>
									</div>

									<div class="col-md-5 text-md-end">
										<button type="submit" class="btn btn-indigo-brand btn-lg rounded-pill px-5 py-3 fw-bold shadow-lg w-100 w-md-auto">
											Procéder au paiement
											<i class="fas fa-lock ms-2"></i>
										</button>
										<div class="text-white-50 x-small mt-3">
											<i class="fab fa-stripe me-1"></i>
											Paiement sécurisé et facturation automatisée
										</div>
									</div>
								</div>
							</div>

						</div>
					</div>
				</form>

				<p class="text-center text-muted mt-4 small">
					<i class="fas fa-shield-check me-1"></i>
					Transaction sécurisée par Stripe. Vos données sont protégées par le RGPD.
				</p>
			</div>
		</div>
	</div>

	<style>:root
	{
		--indigo-brand: #6366f1;
		--indigo-hover: #4f46e5;
	}

	.fw-black {
		font-weight: 900;
	}
	.text-indigo-brand {
		color: var(--indigo-brand);
	}
	.bg-indigo-brand {
		background-color: var(--indigo-brand);
	}
	.btn-indigo-brand {
		background-color: var(--indigo-brand);
		color: white;
		border: none;
	}
	.btn-indigo-brand:hover {
		background-color: var(--indigo-hover);
		color: white;
		transform: translateY(-2px);
	}

	.x-small {
		font-size: 0.75rem;
	}

	/* Forfaits */
	.selection-card {
		cursor: pointer;
		transition: all 0.2s ease;
		border: 2px solid #edf2f7;
		background: #fff;
	}
	.btn-check:checked + .selection-card {
		border-color: var(--indigo-brand) !important;
		background-color: #f8faff;
		box-shadow: 0 4px 12px rgba(99, 102, 241, 0.1);
	}

	/* Addons Grid */
	.addon-grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
		gap: 15px;
	}
	.addon-box {
		display: block;
		padding: 15px;
		border: 2px solid #edf2f7;
		border-radius: 12px;
		cursor: pointer;
		transition: 0.2s;
		text-align: center;
		background: #fff;
	}
	.btn-check:checked + .addon-box {
		border-color: var(--indigo-brand);
		background-color: #f8faff;
	}

	.card {
		border: none;
	}
</style>

<script>
	document.addEventListener('DOMContentLoaded', function () {
const inputs = document.querySelectorAll('.plan-input, .addon-input');
const totalDisplay = document.getElementById('total-price');

function calculate() {
let totalCents = 0;
inputs.forEach(i => {
if (i.checked) 
totalCents += parseInt(i.dataset.price);

});
const totalEuro = (totalCents / 100).toFixed(2);
totalDisplay.innerText = totalEuro.replace('.', ',');
}

inputs.forEach(i => i.addEventListener('change', calculate));
calculate();
});
</script>{% endblock %}
